# setup-proxmox
Proxmoxサーバの初期設定を行う（ローカルストレージ、Ceph)

## 1. 概要

### 1.1 システム構成

本手順書では、r760xs1-5の5ノードに対して以下の2層ストレージ構成を構築します:

```
┌─────────────────────────────────────────────────────────────┐
│                   ストレージ階層アーキテクチャ                    │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  【レイヤー1: ローカルNVMeストレージ】                           │
│  ┌──────────┬──────────┬──────────┬──────────┬──────────┐   │
│  │r760xs1   │r760xs2   │r760xs3   │r760xs4   │r760xs5   │   │
│  │/dev/nvme0│/dev/nvme0│/dev/nvme0│/dev/nvme0│/dev/nvme0│   │
│  │→ local   │→ local   │→ local   │→ local   │→ local   │   │
│  └──────────┴──────────┴──────────┴──────────┴──────────┘   │
│     用途: etcd、ログ、一時データ (低レイテンシワークロード)        │
│                                                               │
│  【レイヤー2: Cephクラスタ (分散ストレージ)】                    │
│  ┌──────────┬──────────┬──────────┬──────────┬──────────┐   │
│  │OSD×N     │OSD×N     │OSD×N     │OSD×N     │OSD×N     │   │
│  │nvme1-X   │nvme1-X   │nvme1-X   │nvme1-X   │nvme1-X   │   │
│  └────┬─────┴────┬─────┴────┬─────┴────┬─────┴────┬─────┘   │
│       └──────────┴──────────┴──────────┴──────────┘         │
│           Ceph Cluster (Replica 3, 100GbE Network)           │
│     用途: VM/コンテナボリューム、共有ストレージ (汎用ワークロード)   │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 設計方針

**ローカルNVMeストレージ:**
- 各ノードの**最初の1台**のNVMeディスク (/dev/nvme0n1) をローカルストレージとして構成
- 用途: Kubernetes etcd、ログ、一時データ等の低レイテンシが必要なワークロード
- 冗長性: なし (アプリケーション層で冗長化)
- 命名: `local-nvme` (Proxmox Storage ID)

**Cephクラスタ:**
- 各ノードの**残りのNVMeディスク** (/dev/nvme1n1以降) をCeph OSDとして構成
- 用途: VM/コンテナの汎用ストレージ
- 冗長性: Ceph Replica 3
- 命名: `ceph-rbd`, `cephfs` (Proxmox Storage ID)

### 1.3 想定ハードウェア構成

| ノード | 管理IP | ストレージIP | 想定NVMe構成 |
|--------|--------|-------------|-------------|
| r760xs1 | 172.16.100.11 | 172.16.200.11 | nvme0n1 (local) + nvme1n1-3n1 (Ceph OSD×3) |
| r760xs2 | 172.16.100.12 | 172.16.200.12 | nvme0n1 (local) + nvme1n1-4n1 (Ceph OSD×4) |
| r760xs3 | 172.16.100.13 | 172.16.200.13 | nvme0n1 (local) + nvme1n1-4n1 (Ceph OSD×4) |
| r760xs4 | 172.16.100.14 | 172.16.200.14 | nvme0n1 (local) + nvme1n1-4n1 (Ceph OSD×4) |
| r760xs5 | 172.16.100.15 | 172.16.200.15 | nvme0n1 (local) + nvme1n1-4n1 (Ceph OSD×4) |

**注:** 実際のデバイス名は環境により異なるため、Phase 1で確認します。

####  ディレクトリ構造

```
/var/lib/local-nvme/
├── kubernetes/          # Kubernetes関連データ
│   ├── etcd/           # etcdデータディレクトリ (VMマウント)
│   └── local-volumes/  # Kubernetesローカルボリューム
├── logs/               # 高速ログストレージ
├── temp/               # 一時データ
└── images/             # Proxmox VM/コンテナイメージ (Proxmox管理)
    ├── template/
    └── private/
```